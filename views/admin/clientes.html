<!-- CSS do DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!-- JS do DataTables -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>



<div class="card mb-4">
  <div class="card-header d-flex justify-content-center">
    <h3 class="card-title mb-0">CLIENTE</h3>
  </div>

  <!-- /.card-header -->
  <!--begin::App Content-->
  <div class="app-content">
    <!--begin::Container-->
    <div class="container-fluid">
      <!--begin::Row-->
      <div class="row">
        <div class="card mb-4">
          <div class="card-header">
            <h3 class="card-title">Informações para contato</h3>
          </div>
          <!-- /.card-header -->
          <div class="table-responsive">
            <table id="tabela_titulares" class="table table-striped">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Nome Completo</th>
                  <th>Telefone</th>
                  <th>Estado Civil</th>
                  <th>RG</th>
                  <th>CPF</th>
                  <th>SEXO</th>
                  <th>Status</th>
                  <th>NIS</th>
                  <th>Data Nascimento</th>
                  <th>Idade</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody>
                {loop="$lista_titulares"}
                <tr>
                  <td>{$value.id}</td>
                  <td>{$value.nome_completo}</td>
                  <td>{$value.telefone}</td>
                  <td>{$value.estado_civil}</td>
                  <td>{$value.rg}</td>
                  <td>{$value.cpf}</td>
                  <td>{$value.genero_cliente}</td>
                  <td>{$value.status_cliente}</td>
                  <td>{$value.nis}</td>
                  <td>{$value.data_nascimento}</td>
                  <td>{$value.idade_cliente}</td>
                  <td>
                    <div class="btn-group" role="group">
                      <button class="btn btn-sm btn-primary btn-detalhes" data-bs-toggle="modal"
                        data-bs-target="#modalRelatorio" data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Visualizar detalhes do titular" data-id="{$value.id}" data-nome="{$value.nome_completo}"
                        data-social="{$value.nome_social}" data-mae="{$value.nome_mae}" data-cor="{$value.cor_cliente}"
                        data-telefone="{$value.telefone}" data-estado="{$value.estado_civil}" data-rg="{$value.rg}"
                        data-cpf="{$value.cpf}" data-sexo="{$value.genero_cliente}"
                        data-status="{$value.status_cliente}" data-nis="{$value.nis}"
                        data-nascimento="{$value.data_nascimento}" data-idade="{$value.idade_cliente}"
                        data-cep="{$value.cep}" data-bairro="{$value.bairro}" data-rua="{$value.rua}"
                        data-numero="{$value.numero}" data-referencia="{$value.referencia}"
                        data-nacionalidade="{$value.nacionalidade}" data-naturalidade="{$value.naturalidade}"
                        data-tempo="{$value.tempo_moradia}" data-cidade="{$value.cidade}">
                        <i class="bi bi-eye"></i>
                      </button>

                      <a href="/admin/clientes/{$value.id}" class="btn btn-warning btn-sm" data-bs-toggle="tooltip"
                        title="Editar">
                        <i class="bi bi-pencil"></i>
                      </a>

                      <a href="/admin/clientes/{$value.id}/delete"
                        onclick="return confirm('Deseja realmente excluir este registro?')"
                        class="btn btn-danger btn-sm" data-bs-toggle="tooltip" title="Excluir">
                        <i class="bi bi-trash"></i>
                      </a>
                    </div>
                  </td>
                </tr>
                {/loop}
              </tbody>
            </table>

            <!-- MODAL MODERNO COM ABAS -->
            <!-- MODAL MODERNO AJUSTADO -->
            <!-- MODAL MODERNO ESTILO CRM -->
            <div class="modal fade" id="modalRelatorio" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">

                  <!-- CABEÇALHO -->
                  <div class="modal-header bg-primary text-white py-3">
                    <h5 class="modal-title d-flex align-items-center">
                      <i class="bi bi-person-lines-fill me-2"></i> Detalhes do Titular
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                      aria-label="Fechar"></button>
                  </div>

                  <!-- CORPO COM ABAS -->
                  <div class="modal-body">

                    <!-- NAV DAS ABAS -->
                    <ul class="nav nav-tabs mb-4" id="modalTabs" role="tablist">
                      <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-dados-tab" data-bs-toggle="tab"
                          data-bs-target="#tab-dados" type="button" role="tab" aria-controls="tab-dados"
                          aria-selected="true">
                          <i class="bi bi-person me-1"></i> Dados Pessoais
                        </button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-endereco-tab" data-bs-toggle="tab"
                          data-bs-target="#tab-endereco" type="button" role="tab" aria-controls="tab-endereco"
                          aria-selected="false">
                          <i class="bi bi-geo-alt me-1"></i> Endereço
                        </button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-dependentes-tab" data-bs-toggle="tab"
                          data-bs-target="#tab-dependentes" type="button" role="tab" aria-controls="tab-dependentes"
                          aria-selected="false">
                          <i class="bi bi-people me-1"></i> Dependentes
                        </button>
                      </li>
                    </ul>

                    <!-- CONTEÚDO DAS ABAS -->
                    <div class="tab-content" id="modalTabsContent">

                      <!-- ABA DADOS PESSOAIS -->
                      <div class="tab-pane fade show active" id="tab-dados" role="tabpanel"
                        aria-labelledby="tab-dados-tab">
                        <div class="row g-3">
                          <div class="col-md-6">
                            <div class="card shadow-sm mb-3 p-3 border-start border-4 border-primary">
                              <h6 class="text-primary mb-3"><i class="bi bi-info-circle me-1"></i> Informações Pessoais
                              </h6>
                              <p class="mb-2"><b>ID:</b> <span id="m_id"></span></p>
                              <p class="mb-2"><b>Nome Completo:</b> <span id="m_nome"></span></p>
                              <p class="mb-2"><b>Nome Social:</b> <span id="m_social"></span></p>
                              <p class="mb-2"><b>Nome da Mãe:</b> <span id="m_mae"></span></p>
                              <p class="mb-2"><b>Cor/Etnia:</b> <span id="m_cor"></span></p>
                              <p class="mb-2"><b>Telefone:</b> <span id="m_telefone"></span></p>
                              <p class="mb-2"><b>Estado Civil:</b> <span id="m_estado"></span></p>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="card shadow-sm mb-3 p-3 border-start border-4 border-success">
                              <h6 class="text-success mb-3"><i class="bi bi-person-check me-1"></i> Documentos & Sexo
                              </h6>
                              <p class="mb-2"><b>RG:</b> <span id="m_rg"></span></p>
                              <p class="mb-2"><b>CPF:</b> <span id="m_cpf"></span></p>
                              <p class="mb-2"><b>Sexo:</b> <span id="m_sexo"></span></p>
                              <p class="mb-2"><b>Status:</b> <span id="m_status"></span></p>
                              <p class="mb-2"><b>NIS:</b> <span id="m_nis"></span></p>
                              <p class="mb-2"><b>Data de Nascimento:</b> <span id="m_nascimento"></span></p>
                              <p class="mb-2"><b>Idade:</b> <span id="m_idade"></span></p>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- ABA ENDEREÇO -->
                      <div class="tab-pane fade" id="tab-endereco" role="tabpanel" aria-labelledby="tab-endereco-tab">
                        <div class="card shadow-sm mb-3 p-3 border-start border-4 border-info">
                          <h6 class="text-info mb-3"><i class="bi bi-geo-alt me-1"></i> Endereço</h6>
                          <div class="row g-3">
                            <div class="col-md-6">
                              <p class="mb-2"><b>CEP:</b> <span id="m_cep"></span></p>
                              <p class="mb-2"><b>Bairro:</b> <span id="m_bairro"></span></p>
                              <p class="mb-2"><b>Rua:</b> <span id="m_rua"></span></p>
                              <p class="mb-2"><b>Número:</b> <span id="m_numero"></span></p>
                              <p class="mb-2"><b>Referência:</b> <span id="m_referencia"></span></p>
                            </div>
                            <div class="col-md-6">
                              <p class="mb-2"><b>Nacionalidade:</b> <span id="m_nacionalidade"></span></p>
                              <p class="mb-2"><b>Naturalidade:</b> <span id="m_naturalidade"></span></p>
                              <p class="mb-2"><b>Tempo de Moradia:</b> <span id="m_tempo"></span></p>
                              <p class="mb-2"><b>Cidade:</b> <span id="m_cidade"></span></p>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- ABA DEPENDENTES -->
                      <div class="tab-pane fade" id="tab-dependentes" role="tabpanel"
                        aria-labelledby="tab-dependentes-tab">
                        <div class="card shadow-sm mb-3 p-3 border-start border-4 border-warning">
                          <h6 class="text-warning mb-3">
                            <i class="bi bi-people me-1"></i> Dependentes
                          </h6>
                          <div id="m_dependentes">
                            <p class="text-muted">Selecione um titular...</p>
                          </div>
                        </div>
                      </div>

                      <!-- Modal Edição Dependente -->
                      <div class="modal fade" id="modalEditarDependente" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                          <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                              <h5 class="modal-title">Editar Dependente</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Fechar"></button>
                            </div>
                            <div class="modal-body">
                              <input type="hidden" id="editIdDependente">
                              <div class="mb-3">
                                <label>Nome</label>
                                <input type="text" id="editNome" class="form-control">
                              </div>
                              <div class="mb-3">
                                <label>Parentesco</label>
                                <input type="text" id="editParentesco" class="form-control">
                              </div>
                              <div class="mb-3">
                                <label>Idade</label>
                                <input type="number" id="editIdade" class="form-control">
                              </div>
                              <div class="mb-3">
                                <label>Sexo</label>
                                <select id="editGenero" class="form-control">
                                  <option value="">Selecione</option>
                                  <option value="Masculino">Masculino</option>
                                  <option value="Feminino">Feminino</option>
                                </select>
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                              <button type="button" class="btn btn-primary"
                                onclick="salvarEdicaoDependente()">Salvar</button>
                            </div>
                          </div>
                        </div>
                      </div>



                    </div>
                  </div>

                  <!-- RODAPÉ -->
                  <div class="modal-footer justify-content-end">
                    <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">
                      <i class="bi bi-x-circle me-1"></i> Fechar
                    </button>
                  </div>

                </div>
              </div>
            </div>


          </div>
          <!-- /.card-body -->
          <div class="card-footer clearfix">
            <ul class="pagination pagination-sm m-0 float-end">
              <li class="page-item"><a class="page-link" href="#">&laquo;</a></li>
              <li class="page-item"><a class="page-link" href="#">1</a></li>
              <li class="page-item"><a class="page-link" href="#">2</a></li>
              <li class="page-item"><a class="page-link" href="#">3</a></li>
              <li class="page-item"><a class="page-link" href="#">&raquo;</a></li>
            </ul>
          </div>
        </div> <!-- fim do card mb-4 -->

      </div> <!-- fim da row -->

    </div> <!--end::Container-->
  </div> <!--end::App Content-->

  <!-- /.card-body -->
  <div class="card-footer d-flex gap-2">
    <a href="/admin/clientes/create" class="btn btn-sm btn-primary">
      NOVO TITULAR
    </a>

    <a href="/admin/dependente/create" class="btn btn-sm btn-primary">
      NOVO DEPENDENTE
    </a>
  </div>





</div> <!-- fim do card principal -->

<script>
  $(document).ready(function () {

    // Inicializa DataTable

    $('#tabela_titulares').DataTable({
      language: {
        url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json"
      }
      , // arquivo local
      paging: true,
      searching: true,
      ordering: true,
      info: true,
      pageLength: 10
    });



    let titularAtual = null;

    // Função para preencher os dados do titular no modal
    function preencherDadosTitular(button) {
      if (!button) return;

      $('#m_id').text(button.dataset.id);
      $('#m_nome').text(button.dataset.nome);
      $('#m_social').text(button.dataset.social);
      $('#m_mae').text(button.dataset.mae);
      $('#m_cor').text(button.dataset.cor);
      $('#m_telefone').text(button.dataset.telefone);
      $('#m_estado').text(button.dataset.estado);
      $('#m_rg').text(button.dataset.rg);
      $('#m_cpf').text(button.dataset.cpf);
      $('#m_sexo').text(button.dataset.sexo);
      $('#m_status').text(button.dataset.status);
      $('#m_nis').text(button.dataset.nis);
      $('#m_nascimento').text(button.dataset.nascimento);
      $('#m_idade').text(button.dataset.idade);
      $('#m_cep').text(button.dataset.cep);
      $('#m_bairro').text(button.dataset.bairro);
      $('#m_rua').text(button.dataset.rua);
      $('#m_numero').text(button.dataset.numero);
      $('#m_referencia').text(button.dataset.referencia);
      $('#m_nacionalidade').text(button.dataset.nacionalidade);
      $('#m_naturalidade').text(button.dataset.naturalidade);
      $('#m_tempo').text(button.dataset.tempo);
      $('#m_cidade').text(button.dataset.cidade);

      titularAtual = button.dataset.id;
    }

    // Função para carregar dependentes
    function carregarDependentes() {
      const container = $('#m_dependentes');
      if (!titularAtual) {
        container.html('<p class="text-muted">Selecione um titular...</p>');
        return;
      }

      // Skeleton de loading
      container.html(`
<div class="d-flex flex-column gap-2">
  <div class="skeleton-card"></div>
  <div class="skeleton-card"></div>
  <div class="skeleton-card"></div>
</div>
`);

      $.ajax({
        url: `/admin/dependentes/ajax/${titularAtual}`,
        method: 'GET',
        dataType: 'json',
        success: function (deps) {
          if (!deps || deps.length === 0) {
            container.html(`
<div class="text-center text-muted py-3">
  <i class="fas fa-user-friends fa-2x mb-2"></i>
  <p>Nenhum dependente cadastrado.</p>
</div>
`);
            return;
          }

          let html = '';
          deps.forEach(d => {
            html += `
<div class="card mb-2 shadow-sm">
  <div class="card-body d-flex justify-content-between align-items-start">
    <div>
      <p><b>Nome:</b> ${d.nome}</p>
      <p><b>Parentesco:</b> ${d.dependencia_cliente}</p>
      <p><b>Idade:</b> ${d.idade ?? '-'}</p>
      <p><b>Sexo:</b> ${d.genero ?? '-'}</p>
    </div>
    <div class="btn-group-vertical">
      <button class="btn btn-sm btn-primary mb-1" onclick="editarDependente(${d.id})">
        <i class="fas fa-edit"></i> Editar
      </button>
      <button class="btn btn-sm btn-danger" onclick="excluirDependente(${d.id})">
        <i class="fas fa-trash"></i> Excluir
      </button>
    </div>
  </div>
</div>
`;
          });

          container.html(html);
        },
        error: function (xhr) {
          console.error("Erro ao carregar dependentes:", xhr.responseText);
          container.html('<p class="text-danger">Erro ao carregar dependentes.</p>');
        }
      });
    }

    // Abrir modal do titular
    $('#modalRelatorio').on('show.bs.modal', function (event) {
      const button = event.relatedTarget || {}; // Proteção caso seja undefined
      preencherDadosTitular(button);
      carregarDependentes();
    });

    // Recarregar dependentes quando a aba é clicada
    $('#tab-dependentes-tab').on('shown.bs.tab', function () {
      carregarDependentes();
    });

    // Excluir dependente
    window.excluirDependente = function (idDep) {
      if (!confirm("Tem certeza que deseja excluir este dependente?")) return;

      $.ajax({
        url: `/admin/dependentes/excluir/${idDep}`,
        method: 'DELETE',
        success: function () {
          alert("Dependente excluído!");
          carregarDependentes();
        },
        error: function () {
          alert("Erro ao excluir dependente!");
        }
      });
    }

  });

  // Editar dependente
  function editarDependente(idDep) {
    $.ajax({
      url: `/admin/dependentes/get/${idDep}`, // ajuste para sua rota real
      method: 'GET',
      dataType: 'json',
      success: function (d) {
        $('#editIdDependente').val(d.id);
        $('#editNome').val(d.nome);
        $('#editParentesco').val(d.dependencia_cliente);
        $('#editIdade').val(d.idade);
        $('#editGenero').val(d.genero);

        const modal = new bootstrap.Modal(document.getElementById('modalEditarDependente'));
        modal.show();
      },
      error: function () {
        alert("Erro ao carregar dependente!");
      }
    });
  }

  // Salvar alterações via AJAX
  $('#btnSalvarEdicao').on('click', function () {
    const idDep = $('#editIdDependente').val();
    const data = {
      nome: $('#editNome').val(),
      dependencia_cliente: $('#editParentesco').val(),
      idade: $('#editIdade').val(),
      genero: $('#editGenero').val()
    };

    $.ajax({
      url: `/admin/dependentes/editar/${idDep}`,
      method: 'POST',
      data: JSON.stringify(data),
      contentType: 'application/json',
      success: function () {
        alert("Dependente atualizado com sucesso!");
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarDependente'));
        modal.hide();
        carregarDependentes();
      },
      error: function () {
        alert("Erro ao salvar dependente!");
      }
    });
  });
</script>





<style>
  /* Skeleton geral */
  .skeleton-card {
    height: 100px;
    width: 100%;
    border-radius: 8px;
    background: linear-gradient(90deg, #eee 25%, #ddd 50%, #eee 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    margin-bottom: 12px;
  }

  @keyframes shimmer {
    0% {
      background-position: -200% 0;
    }

    100% {
      background-position: 200% 0;
    }
  }

  /* Skeleton linha interna (opcional) */
  .skeleton-line {
    height: 12px;
    width: 80%;
    margin-bottom: 8px;
    border-radius: 4px;
    background: linear-gradient(90deg, #eee 25%, #ddd 50%, #eee 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }
</style>