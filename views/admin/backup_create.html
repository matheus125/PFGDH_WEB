<div class="card card-info card-outline mb-4">
  <div class="card-header">
    <h3 class="card-title">Ficha Social - CENAF</h3>
  </div>

  <div class="card-body">

    <!-- NAV TABS -->
    <ul class="nav nav-tabs" id="fichaTabs" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="tab-titular" data-bs-toggle="tab" href="#titular" role="tab">Titular</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="tab-dependentes" data-bs-toggle="tab" href="#dependentes" role="tab">Dependentes</a>
      </li>
    </ul>

    <div class="tab-content mt-3" id="fichaTabsContent">
      <!-- üßç ABA TITULAR -->
      <div class="tab-pane fade show active" id="titular" role="tabpanel">
        <form id="fichaSocialForm" action="/admin/usuarios/create" method="post" class="needs-validation" novalidate>
          <div class="row g-3">
            <!-- Identifica√ß√£o -->
            <div class="col-md-6">
              <label class="form-label">Nome</label>
              <input type="text" class="form-control" name="nome" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Endere√ßo</label>
              <input type="text" class="form-control" name="endereco">
            </div>
            <div class="col-md-1">
              <label class="form-label">N¬∫</label>
              <input type="text" class="form-control" name="numero">
            </div>
            <div class="col-md-2">
              <label class="form-label">Complemento</label>
              <input type="text" class="form-control" name="complemento">
            </div>
            <div class="col-md-3">
              <label class="form-label">Bairro</label>
              <input type="text" class="form-control" name="bairro">
            </div>
            <div class="col-md-3">
              <label class="form-label">Cidade</label>
              <input type="text" class="form-control" name="cidade">
            </div>
            <div class="col-md-1">
              <label class="form-label">UF</label>
              <input type="text" class="form-control" name="uf" maxlength="2">
            </div>
            <div class="col-md-2">
              <label class="form-label">CEP</label>
              <input type="text" class="form-control" name="cep">
            </div>
            <div class="col-md-3">
              <label class="form-label">Telefone</label>
              <input type="text" class="form-control" name="telefone">
            </div>
            <div class="col-md-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" name="email">
            </div>
            <div class="col-md-3">
              <label class="form-label">RG</label>
              <input type="text" class="form-control" name="rg">
            </div>
            <div class="col-md-3">
              <label class="form-label">CPF</label>
              <input type="text" class="form-control" name="cpf">
            </div>
            <div class="col-md-3">
              <label class="form-label">Data de Nascimento</label>
              <input type="date" class="form-control" name="data_nascimento">
            </div>
            <div class="col-md-3">
              <label class="form-label">Estado Civil</label>
              <select class="form-select" name="estado_civil">
                <option value="">Selecione...</option>
                <option>Solteiro</option>
                <option>Casado</option>
                <option>Vi√∫vo</option>
                <option>Separado</option>
                <option>Outros</option>
              </select>
            </div>

            <!-- Escolaridade -->
            <div class="col-md-12 mt-3">
              <label class="form-label fw-bold">Grau de Escolaridade</label><br>
              <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox"
                  name="escolaridade[]" value="[Ensino M√©dio Completo]"> Ensino M√©dio Completo</div>
            </div>

            <!-- Trabalho -->
            <div class="col-md-6 mt-3">
              <label class="form-label">Profiss√£o</label>
              <input type="text" class="form-control" name="profissao">
            </div>
            <div class="col-md-6 mt-3">
              <label class="form-label">Trabalha atualmente?</label><br>
              <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="trabalha"
                  value="Sim"> Sim</div>
              <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="trabalha"
                  value="N√£o"> N√£o</div>
            </div>

            <!-- Benef√≠cios -->
            <div class="col-md-12 mt-3">
              <label class="form-label">Recebe benef√≠cio do governo?</label><br>
              <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="beneficio"
                  value="Sim"> Sim</div>
              <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="beneficio"
                  value="N√£o"> N√£o</div>
            </div>
            <div class="col-md-12 mt-2">
              <label class="form-label">Tipo de Benef√≠cio</label><br>
              <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox"
                  name="tipo_beneficio[]" value="Aposentadoria"> Aposentadoria</div>
              <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox"
                  name="tipo_beneficio[]" value="Pens√£o"> Pens√£o</div>
              <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox"
                  name="tipo_beneficio[]" value="Bolsa Fam√≠lia"> Bolsa Fam√≠lia</div>
              <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox"
                  name="tipo_beneficio[]" value="BPC"> BPC</div>
            </div>
          </div>

          <div class="card-footer mt-3">
            <button type="submit" class="btn btn-info">Salvar Titular</button>
          </div>
        </form>
      </div>

      <!-- üë®‚Äçüë©‚Äçüëß ABA DEPENDENTES -->
      <div class="tab-pane fade" id="dependentes" role="tabpanel">
        <form id="formDependente" action="/admin/dependentes/save" method="post">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold text-primary mb-0">
              üë®‚Äçüë©‚Äçüëß Cadastro de Dependentes
            </h5>
            <button type="button" class="btn btn-success" id="btn-add-dependente">
              <i class="fas fa-plus"></i> Adicionar Dependente
            </button>
          </div>

          <div id="dependentes-container" class="mt-3">
            <!-- Dependente 1 -->
            <div class="card shadow-sm mb-3 dependente-item">
              <div class="card-header bg-light">
                <strong><i class="fas fa-user"></i> Dependente 1</strong>
              </div>
              <div class="card-body">
                <div class="row g-3 align-items-center">
                  <div class="col-md-5">
                    <label class="form-label">Nome do Dependente</label>
                    <input type="text" class="form-control" name="dependentes[0][nome]"
                      placeholder="Digite o nome completo">
                  </div>

                  <div class="col-md-3">
                    <label class="form-label d-block">Possui Defici√™ncia?</label>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input possui-deficiencia-sim" type="radio"
                        name="dependentes[0][possui_deficiencia]" value="sim">
                      <label class="form-check-label">Sim</label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input possui-deficiencia-nao" type="radio"
                        name="dependentes[0][possui_deficiencia]" value="nao" checked>
                      <label class="form-check-label">N√£o</label>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <label class="form-label">Tipo de Defici√™ncia</label>
                    <select class="form-select tipo-deficiencia" name="dependentes[0][tipo_deficiencia]" disabled>
                      <option value="">Selecione...</option>
                      <option>Visual</option>
                      <option>F√≠sica</option>
                      <option>Auditiva</option>
                      <option>Intelectual</option>
                      <option>Outras</option>
                    </select>
                  </div>

                  <div class="col-md-1 text-end">
                    <button type="button" class="btn btn-danger btn-remover-dependente mt-3" title="Remover Dependente">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>

        <!-- LISTAGEM DEPENDENTES -->
        <div class="mt-4">
          <h5>Lista de Dependentes</h5>
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Parentesco</th>
                <th>Idade</th>
                <th>Escolaridade</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="listaDependentes">
              <tr>
                <td colspan="5" class="text-center">Nenhum dependente adicionado</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // TITULAR
  (() => {
    const form = document.getElementById('fichaSocialForm');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);

      const data = Object.fromEntries(formData.entries());
      data.grau_escolaridade = JSON.stringify(formData.getAll('escolaridade[]'));
      data.tipo_beneficio = JSON.stringify(formData.getAll('tipo_beneficio[]'));
      data.trabalha_atualmente = formData.get('trabalha') || 'N√£o';
      data.recebe_beneficio_governo = formData.get('beneficio') || 'N√£o';

      const res = await fetch(form.action, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const json = await res.json();
      alert(json.message);
    });
  })();

  // DEPENDENTES
  document.addEventListener("DOMContentLoaded", function () {
    const container = document.getElementById("dependentes-container");
    const btnAdd = document.getElementById("btn-add-dependente");
    let dependenteIndex = 1;

    // Configura eventos de cada card
    function configurarEventos(item) {
      const sim = item.querySelector(".possui-deficiencia-sim");
      const nao = item.querySelector(".possui-deficiencia-nao");
      const tipo = item.querySelector(".tipo-deficiencia");
      const remover = item.querySelector(".btn-remover-dependente");

      const toggle = (enable) => {
        tipo.disabled = !enable;
        tipo.style.backgroundColor = enable ? "#fff" : "#e9ecef";
      };
      sim.addEventListener("change", () => toggle(true));
      nao.addEventListener("change", () => toggle(false));

      remover.addEventListener("click", () => {
        const total = document.querySelectorAll(".dependente-item").length;
        if (total > 1) {
          if (confirm("Deseja remover este dependente?")) {
            item.remove();
            atualizarNumeracao();
          }
        } else {
          alert("Deve haver pelo menos um dependente cadastrado.");
        }
      });
    }

    // Atualiza os t√≠tulos "Dependente 1", "Dependente 2"...
    function atualizarNumeracao() {
      document.querySelectorAll(".dependente-item").forEach((el, i) => {
        const header = el.querySelector(".card-header strong");
        header.innerHTML = `<i class="fas fa-user"></i> Dependente ${i + 1}`;
      });
    }

    configurarEventos(container.querySelector(".dependente-item"));

    // Adicionar novo dependente
    btnAdd.addEventListener("click", () => {
      const novo = document.createElement("div");
      novo.classList.add("card", "shadow-sm", "mb-3", "dependente-item");
      novo.innerHTML = `
      <div class="card-header bg-light">
        <strong><i class="fas fa-user"></i> Dependente ${dependenteIndex + 1}</strong>
      </div>
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-md-5">
            <label class="form-label">Nome do Dependente</label>
            <input type="text" class="form-control" name="dependentes[${dependenteIndex}][nome]" placeholder="Digite o nome completo">
          </div>
          <div class="col-md-3">
            <label class="form-label d-block">Possui Defici√™ncia?</label>
            <div class="form-check form-check-inline">
              <input class="form-check-input possui-deficiencia-sim" type="radio" name="dependentes[${dependenteIndex}][possui_deficiencia]" value="sim">
              <label class="form-check-label">Sim</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input possui-deficiencia-nao" type="radio" name="dependentes[${dependenteIndex}][possui_deficiencia]" value="nao" checked>
              <label class="form-check-label">N√£o</label>
            </div>
          </div>
          <div class="col-md-3">
            <label class="form-label">Tipo de Defici√™ncia</label>
            <select class="form-select tipo-deficiencia" name="dependentes[${dependenteIndex}][tipo_deficiencia]" disabled>
              <option value="">Selecione...</option>
              <option>Visual</option>
              <option>F√≠sica</option>
              <option>Auditiva</option>
              <option>Intelectual</option>
              <option>Outras</option>
            </select>
          </div>
          <div class="col-md-1 text-end">
            <button type="button" class="btn btn-danger btn-remover-dependente mt-3" title="Remover Dependente">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
    `;
      container.appendChild(novo);
      configurarEventos(novo);
      dependenteIndex++;
      atualizarNumeracao();
    });
  });
</script>

<style>
  #dependentes-container .card {
    border-left: 5px solid #0d6efd;
    transition: all 0.25s ease-in-out;
  }

  #dependentes-container .card:hover {
    transform: scale(1.01);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .card-header strong {
    color: #0d6efd;
  }
</style>