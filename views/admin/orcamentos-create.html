<div class="card card-info card-outline mb-4">
  <div class="card-header">
    <h3 class="card-title">ORÇAMENTO</h3>
  </div>

  <!-- Mensagem de Erro -->
  <div id="error-message" class="alert alert-danger d-none" role="alert"></div>

  <form id="form" class="needs-validation" novalidate>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3 mb-2">
          <input class="form-control" name="localizador" placeholder="Localizador" required>
        </div>
        <div class="col-md-3 mb-2">
          <input class="form-control" name="status" placeholder="Status" value="Pendente" required>
        </div>
        <div class="col-md-3 mb-2">
          <input class="form-control" type="datetime-local" name="data_emissao" required>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4 mb-2">
          <input class="form-control" name="origem" placeholder="Origem" required>
        </div>
        <div class="col-md-4 mb-2">
          <input class="form-control" name="destino" placeholder="Destino" required>
        </div>
      </div>
      <div class="row">
        <div class="col-md-2 mb-2">
          <input class="form-control" name="duracao" placeholder="Duração (HH:MM:SS)">
        </div>
        <div class="col-md-2 mb-2">
          <input class="form-control" type="number" name="escalas" placeholder="Escalas" min="0">
        </div>
        <div class="col-md-2 mb-2">
          <input class="form-control" name="bagagem" placeholder="Bagagem">
        </div>
        <div class="col-md-2 mb-2">
          <input class="form-control" name="classe" placeholder="Classe">
        </div>
      </div>
      <div class="row">
        <div class="col-md-2 mb-2">
          <input class="form-control" name="tarifa" placeholder="Tarifa" required>
        </div>
        <div class="col-md-2 mb-2">
          <input class="form-control" name="taxa" placeholder="Taxa" required>
        </div>
        <div class="col-md-2 mb-2">
          <input class="form-control" name="tx_embarque" placeholder="Tx Embarque" required>
        </div>
      </div>

      <div id="errorDiv" class="alert alert-danger d-none" role="alert"></div>
      <button type="submit" class="btn btn-primary">Salvar</button>
    </div>
  </form>

  <!-- Toast sucesso -->
  <div class="toast bg-success text-white position-fixed bottom-0 end-0 m-3" id="toast-success" role="alert"
    aria-live="assertive" aria-atomic="true" data-delay="4000">
    <div class="toast-header bg-success text-white">
      <strong class="me-auto">Sucesso</strong>
      <small>agora</small>
      <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast">&times;</button>
    </div>
    <div class="toast-body">Orçamento salvo com sucesso!</div>
  </div>

</div>

<!-- Toast estilo AdminLTE -->
<div class="toast bg-success text-white position-fixed bottom-0 end-0 m-3" id="toast-success" role="alert"
  aria-live="assertive" aria-atomic="true" data-delay="4000">
  <div class="toast-header bg-success text-white">
    <strong class="me-auto">Sucesso</strong>
    <small>agora</small>
    <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast">&times;</button>
  </div>
  <div class="toast-body">
    Formulário enviado com sucesso!
  </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/inputmask/5.0.8/jquery.inputmask.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("form"); // pega o form pelo id

    form.addEventListener("submit", async function (e) {
      e.preventDefault(); // evita recarregar a página

      // coleta todos os dados do form
      const formData = new FormData(form);
      const data = {};

      formData.forEach((value, key) => {
        data[key] = value;
      });

      try {
        const response = await fetch("/admin/orcamentos/salvar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok && result.success) {
          alert("✅ Orçamento salvo com sucesso!");

          // redireciona para listagem
          window.location.href = "/admin/orcamentos";
        } else {
          document.getElementById("errorDiv").classList.remove("d-none");
          document.getElementById("errorDiv").innerText = result.message || "Erro ao salvar.";
        }

      } catch (error) {
        console.error("Erro no fetch:", error);
        document.getElementById("errorDiv").classList.remove("d-none");
        document.getElementById("errorDiv").innerText = "Falha na comunicação com o servidor.";
      }
    });
  });
</script>